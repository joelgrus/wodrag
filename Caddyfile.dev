# Caddy configuration for local development (no TLS/ACME)

{
  auto_https off
}

:80 {
  encode zstd gzip

  # Explicit routing: API first, then SPA
  route {
    # Proxy API to backend FastAPI service (preserve full path)
    handle /api/* {
      reverse_proxy backend:8000 {
        header_up X-Forwarded-For {remote_host}
        header_up X-Real-IP {remote_host}
        header_up Host {host}
        transport http {
          response_header_timeout 60s
          dial_timeout 10s
        }
      }
    }

    # SPA/static file handling
    handle {
      root * /usr/share/caddy
      try_files {path} /index.html
      file_server
    }
  }

  # Cache static assets aggressively
  @static {
    path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
  }
  header @static Cache-Control "public, max-age=31536000, immutable"

  log {
    output stdout
    format console
  }
}
